{% extends "base.html" %}

{% block title %}{{collection.name}}{% endblock %}

{% block head_extra %}
<style>
    .watch-layout {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 16px;
        align-items: start;
    }
    .admin-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        align-items: start;
    }
    .admin-wide {
        grid-column: 1 / -1;
    }
    @media (max-width: 900px) {
        .watch-layout {
            grid-template-columns: 1fr;
        }
        .admin-layout {
            grid-template-columns: 1fr;
        }
        .admin-wide {
            grid-column: auto;
        }
    }
    .playlist-item {
        display: block;
        width: 100%;
        text-align: left;
        color: #ece7df;
        border: 1px solid #3a332a;
        border-radius: 6px;
        background: #222222;
        padding: 8px 10px;
        margin-bottom: 8px;
        cursor: pointer;
    }
    .playlist-item.active {
        border-color: #d6b98c;
        background: #3a3123;
    }
    .status-chip {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        border: 1px solid;
        font-size: 12px;
        line-height: 1.4;
    }
    .status-complete {
        color: #9fbba3;
        background: #1f2a22;
        border-color: #3f5444;
    }
    .status-processing {
        color: #c2ae8f;
        background: #2d261c;
        border-color: #5a4a33;
    }
    .status-missing,
    .status-pending,
    .status-failed {
        color: #be9a9a;
        background: #2d2020;
        border-color: #5a3d3d;
    }
    .progress-track {
        width: 130px;
        height: 8px;
        background: #2a2a2a;
        border: 1px solid #3a332a;
        border-radius: 999px;
        overflow: hidden;
        margin-bottom: 4px;
    }
    .progress-fill {
        height: 100%;
        background: #6f8f7a;
        width: 0%;
    }
    .progress-text {
        color: #b6aa99;
        font-size: 12px;
    }
    .playlist-admin-table-wrap {
        overflow-x: auto;
        border: 1px solid #2a2a2a;
        border-radius: 8px;
    }
    .playlist-admin-table {
        width: 100%;
        min-width: 1080px;
        border-collapse: collapse;
    }
    .playlist-admin-table th {
        text-align: left;
        padding: 10px 8px;
        color: #d7c8b3;
        background: #202020;
        border-bottom: 1px solid #2f2f2f;
        font-weight: 600;
        vertical-align: top;
    }
    .playlist-admin-table td {
        padding: 8px;
        border-bottom: 1px solid #2a2a2a;
        vertical-align: top;
    }
    .playlist-admin-table tbody tr:last-child td {
        border-bottom: none;
    }
    .admin-video-filename {
        color: #b6aa99;
        max-width: 220px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .compact-input {
        width: 100%;
    }
    .compact-order {
        width: 84px;
    }
    .is-hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
{% if selected_video or videos %}
<div class="watch-layout">
    {% if selected_video %}
    <div class="card">
        <h3 id="current-video-title">Now Playing: {{ selected_video.display_name or selected_video.filename }}</h3>
        {% if selected_video.description %}
        <p id="current-video-description" style="color: #b6aa99; margin-top: 6px;">{{ selected_video.description }}</p>
        {% else %}
        <p id="current-video-description" style="color: #b6aa99; margin-top: 6px;"></p>
        {% endif %}
        <video id="collection-video" controls width="100%"></video>
    </div>
    {% endif %}

    {% if videos %}
    <div class="card">
        <h3>Playlist</h3>
        {% for v in videos %}
            <button
                type="button"
                class="playlist-item{% if selected_video and v.id == selected_video.id %} active{% endif %}"
                data-video-id="{{ v.id }}"
                data-video-name="{{ v.display_name or v.filename }}"
                data-video-description="{{ (v.description or '')|e }}"
            >
                {{ loop.index }}. {{ v.display_name or v.filename }} ({{ v.duration_seconds|duration_label }})
            </button>
        {% endfor %}
    </div>
    {% endif %}
</div>
{% endif %}

{% if sub_collections %}
<div class="card">
    <h3>Sub-collections</h3>
    <ul>
        {% for c in sub_collections %}
            <li><a href="{{ request.path }}/{{c.slug}}">{{c.name}}</a></li>
        {% endfor %}
    </ul>
</div>
{% endif %}

{% if session.get("admin_logged_in") %}
<div class="admin-layout">
    <div class="card">
        <h3>Collection Settings (Admin)</h3>
        <form method="POST" action="/admin/collection/{{ collection.id }}/settings">
            <input type="hidden" name="return_path" value="{{ request.full_path if request.query_string else request.path }}">
            <label for="collection-name">Collection Name</label><br>
            <input id="collection-name" name="name" type="text" value="{{ collection.name }}" style="margin-top: 8px; margin-bottom: 8px; width: 100%;"><br>

            <label for="collection-slug">URL Slug</label><br>
            <input id="collection-slug" name="slug" type="text" value="{{ collection.slug }}" style="margin-top: 8px; margin-bottom: 8px; width: 100%;"><br>

            <label for="collection-parent">Parent Collection</label><br>
            <select id="collection-parent" name="parent_id" style="margin-top: 8px; margin-bottom: 8px; width: 100%;">
                <option value="">Top-Level</option>
                {% for option in parent_options %}
                    <option value="{{ option.id }}" {% if collection.parent_id == option.id %}selected{% endif %}>{{ option.label }}</option>
                {% endfor %}
            </select><br>

            <label for="collection-visibility">Visibility</label><br>
            <select id="collection-visibility" name="visibility" style="margin-top: 8px; margin-bottom: 8px;">
                <option value="public" {% if collection.visibility == "public" %}selected{% endif %}>Public</option>
                <option value="unlisted" {% if collection.visibility == "unlisted" %}selected{% endif %}>Unlisted</option>
                <option value="private" {% if collection.visibility == "private" %}selected{% endif %}>Private</option>
            </select><br>
            <div style="font-size: 14px; color: #b6aa99; margin-bottom: 10px;">
                Public: shown in parent collection lists.<br>
                Unlisted: hidden from lists, accessible by direct URL.<br>
                Private: admin-only access.
            </div>
            <button type="submit">Save Collection Settings</button>
        </form>
    </div>

    <div class="card">
        <h3>Upload Video to This Collection</h3>
        <form method="POST" action="/upload" enctype="multipart/form-data">
            <input type="hidden" name="collection_id" value="{{ collection.id }}">
            <input type="hidden" name="return_path" value="{{ request.full_path if request.query_string else request.path }}">

            <input id="collection-upload-file" type="file" name="file" required><br><br>

            <label>Custom video title (optional)</label><br>
            <input id="collection-upload-display-name" type="text" name="display_name" placeholder="Example: Week 1 Intro"><br><br>

            <label>Description (optional)</label><br>
            <textarea name="description" rows="3" placeholder="Add notes, agenda, or context for this video" style="width: 100%;"></textarea><br><br>

            <label>Playlist order (optional)</label><br>
            <input type="number" name="sort_order" min="0" placeholder="Auto"><br><br>

            <label>Visibility</label><br>
            <select name="visibility">
                <option value="public">Public</option>
                <option value="unlisted">Unlisted</option>
                <option value="private">Private</option>
            </select><br><br>

            <button type="submit">Upload to This Collection</button>
        </form>
    </div>

    {% if videos %}
    <div class="card admin-wide">
        <h3>Edit Playlist (Admin)</h3>
        <form method="POST" action="/admin/playlist/{{ collection.id }}">
            <input type="hidden" name="return_path" value="{{ request.full_path if request.query_string else request.path }}">
            <div class="playlist-admin-table-wrap">
                <table class="playlist-admin-table">
                    <thead>
                        <tr>
                            <th>Video</th>
                            <th>Custom Name</th>
                            <th>Description</th>
                            <th style="width: 130px;">Visibility</th>
                            <th style="width: 90px;">Length</th>
                            <th style="width: 230px;">HLS</th>
                            <th style="width: 90px;">Order</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for v in videos %}
                        <tr>
                            <td><div class="admin-video-filename" title="{{ v.filename }}">{{ v.filename }}</div></td>
                            <td>
                                <input
                                    type="text"
                                    name="title_{{ v.id }}"
                                    value="{{ v.display_name or v.filename }}"
                                    class="compact-input"
                                >
                            </td>
                            <td>
                                <textarea name="description_{{ v.id }}" rows="2" class="compact-input">{{ v.description or '' }}</textarea>
                            </td>
                            <td>
                                <select name="visibility_{{ v.id }}" class="compact-input">
                                    <option value="public" {% if v.visibility == "public" %}selected{% endif %}>Public</option>
                                    <option value="unlisted" {% if v.visibility == "unlisted" %}selected{% endif %}>Unlisted</option>
                                    <option value="private" {% if v.visibility == "private" %}selected{% endif %}>Private</option>
                                </select>
                            </td>
                            <td style="color: #b6aa99;">{{ v.duration_seconds|duration_label }}</td>
                            <td>
                                <span id="hls-status-{{ v.id }}" class="status-chip status-{{ v.hls_status|lower }}">{{ v.hls_status }}</span>
                                <span id="hls-segments-{{ v.id }}">({{ v.hls_segments_generated }}/{{ v.hls_segments_expected }})</span>
                                {% set progress_pct = v.hls_progress_pct or 0 %}
                                <div id="hls-progress-wrap-{{ v.id }}" class="{% if progress_pct >= 100 %}is-hidden{% endif %}">
                                    <div class="progress-track">
                                        <div id="hls-progress-fill-{{ v.id }}" class="progress-fill" data-progress="{{ progress_pct }}" style="width: 0%;"></div>
                                    </div>
                                    <div id="hls-progress-text-{{ v.id }}" class="progress-text">{{ progress_pct }}% {{ v.hls_step or '' }}</div>
                                </div>
                            </td>
                            <td>
                                <input
                                    type="number"
                                    name="order_{{ v.id }}"
                                    value="{{ v.sort_order }}"
                                    class="compact-order"
                                >
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button type="submit" style="margin-top: 12px;">Save Playlist Changes</button>
        </form>
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function attachAutoTitle(fileInputId, titleInputId) {
    const fileInput = document.getElementById(fileInputId);
    const titleInput = document.getElementById(titleInputId);
    if (!fileInput || !titleInput) return;

    fileInput.addEventListener("change", () => {
        const selectedFile = fileInput.files && fileInput.files[0];
        if (!selectedFile) return;

        const baseName = selectedFile.name.replace(/\.[^/.]+$/, "");
        const lastAuto = titleInput.dataset.lastAutoValue || "";
        const current = titleInput.value.trim();

        if (!current || current === lastAuto) {
            titleInput.value = baseName;
            titleInput.dataset.lastAutoValue = baseName;
        }
    });
}

attachAutoTitle("collection-upload-file", "collection-upload-display-name");
</script>
{% if session.get("admin_logged_in") and videos %}
<script>
const collectionId = "{{ collection.id }}";

function applyHlsProgress(item) {
    const statusEl = document.getElementById(`hls-status-${item.id}`);
    const segmentsEl = document.getElementById(`hls-segments-${item.id}`);
    const progressWrapEl = document.getElementById(`hls-progress-wrap-${item.id}`);
    const fillEl = document.getElementById(`hls-progress-fill-${item.id}`);
    const textEl = document.getElementById(`hls-progress-text-${item.id}`);

    if (!statusEl || !segmentsEl || !progressWrapEl || !fillEl || !textEl) return;

    const normalizedStatus = (item.status || "pending").toLowerCase();
    const progress = Math.max(0, Math.min(100, Number(item.progress_pct || 0)));

    statusEl.textContent = item.status || "pending";
    statusEl.className = `status-chip status-${normalizedStatus}`;
    segmentsEl.textContent = `(${item.segments_generated}/${item.segments_expected})`;
    progressWrapEl.style.display = progress >= 100 ? "none" : "block";
    fillEl.style.width = `${progress}%`;
    textEl.textContent = `${progress}% ${item.step || ""}`.trim();
}

async function refreshHlsProgress() {
    try {
        const res = await fetch(`/admin/hls_progress/${collectionId}`, { cache: "no-store" });
        if (!res.ok) return;
        const payload = await res.json();
        const items = payload.videos || [];
        items.forEach(applyHlsProgress);
    } catch (err) {
    }
}

refreshHlsProgress();
setInterval(refreshHlsProgress, 3000);

document.querySelectorAll(".progress-fill[data-progress]").forEach((el) => {
    const value = Math.max(0, Math.min(100, Number(el.dataset.progress || 0)));
    el.style.width = `${value}%`;
});
</script>
{% endif %}
{% if selected_video %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
const player = document.getElementById("collection-video");
const titleEl = document.getElementById("current-video-title");
const descriptionEl = document.getElementById("current-video-description");
const buttons = Array.from(document.querySelectorAll(".playlist-item"));
let hls = null;
let currentVideoId = "{{ selected_video.id }}";
let viewedVideoIds = new Set();
let lastWatchTime = null;
let pendingWatchDelta = 0;

function sendJson(url, payload, preferBeacon = false) {
    const body = JSON.stringify(payload);
    if (preferBeacon && navigator.sendBeacon) {
        const blob = new Blob([body], { type: "application/json" });
        navigator.sendBeacon(url, blob);
        return;
    }

    fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body,
        keepalive: true,
    }).catch(() => {});
}

function flushWatch(preferBeacon = false) {
    if (!currentVideoId || pendingWatchDelta <= 0) return;
    sendJson("/analytics/video_watch", {
        video_id: currentVideoId,
        current_time: player.currentTime,
        delta_seconds: pendingWatchDelta,
    }, preferBeacon);
    pendingWatchDelta = 0;
}

function sourceFor(videoId) {
    return `/hls/${videoId}/playlist.m3u8`;
}

function setActive(videoId) {
    buttons.forEach((btn) => {
        btn.classList.toggle("active", btn.dataset.videoId === videoId);
    });
}

function loadVideo(videoId, videoName) {
    flushWatch();
    currentVideoId = videoId;
    const src = sourceFor(videoId);
    const storageKey = `resume_${videoId}`;

    if (hls) {
        hls.destroy();
        hls = null;
    }

    if (player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = src;
    } else if (Hls.isSupported()) {
        hls = new Hls();
        hls.loadSource(src);
        hls.attachMedia(player);
    } else {
        player.src = src;
    }

    titleEl.textContent = `Now Playing: ${videoName}`;
    if (descriptionEl) {
        const selected = buttons.find((btn) => btn.dataset.videoId === videoId);
        const description = (selected && selected.dataset.videoDescription) ? selected.dataset.videoDescription : "";
        descriptionEl.textContent = description;
    }
    setActive(videoId);
    const nextUrl = `${window.location.pathname}?v=${videoId}`;
    window.history.replaceState(null, "", nextUrl);

    if (!viewedVideoIds.has(videoId)) {
        viewedVideoIds.add(videoId);
        sendJson("/analytics/video_view", { video_id: videoId });
    }

    player.addEventListener("loadedmetadata", function restoreOnce() {
        const saved = localStorage.getItem(storageKey);
        if (saved) {
            player.currentTime = parseFloat(saved);
        }
        lastWatchTime = player.currentTime;
        player.removeEventListener("loadedmetadata", restoreOnce);
    });
}

player.addEventListener("timeupdate", () => {
    if (!currentVideoId) return;

    if (lastWatchTime !== null) {
        const delta = player.currentTime - lastWatchTime;
        if (delta > 0 && delta < 10) {
            pendingWatchDelta += delta;
        }
    }
    lastWatchTime = player.currentTime;

    if (pendingWatchDelta >= 5) {
        flushWatch();
    }

    localStorage.setItem(`resume_${currentVideoId}`, player.currentTime);
});

player.addEventListener("pause", () => {
    flushWatch();
});

player.addEventListener("ended", () => {
    if (!currentVideoId) return;
    flushWatch();
    localStorage.removeItem(`resume_${currentVideoId}`);
});

window.addEventListener("beforeunload", () => {
    flushWatch(true);
});

buttons.forEach((btn) => {
    btn.addEventListener("click", () => {
        loadVideo(btn.dataset.videoId, btn.dataset.videoName);
    });
});

loadVideo("{{ selected_video.id }}", "{{ selected_video.display_name or selected_video.filename }}");
</script>
{% endif %}
{% endblock %}
