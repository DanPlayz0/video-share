services:
  app:
    build: .
    ports:
      - "${PORT:-5000}:5000"
    environment:
      - APP_ENV=production
      - PORT=5000
      - STORAGE_ROOT=/data
      - DATABASE_PATH=/data/database.db
      - SECRET_KEY=${SECRET_KEY:-CHANGE_THIS_SECRET}
      - ADMIN_USERNAME=${ADMIN_USERNAME:-admin}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-change_this_password}
      - ADMIN_PASSWORD_HASH=${ADMIN_PASSWORD_HASH:-}
      - TRUST_PROXY=true
      - SESSION_COOKIE_SECURE=true
      - MAX_UPLOAD_MB=${MAX_UPLOAD_MB:-2048}
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
      - GUNICORN_THREADS=${GUNICORN_THREADS:-4}
      - GUNICORN_TIMEOUT=${GUNICORN_TIMEOUT:-120}
    volumes:
      - ./data:/data
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:5000/healthz', timeout=2)"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 20s
    restart: unless-stopped